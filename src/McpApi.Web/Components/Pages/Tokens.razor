@page "/tokens"
@using McpApi.Core.Auth
@using McpApi.Core.Models
@using McpApi.Web.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ICurrentUserService CurrentUserService
@inject IMcpTokenService TokenService
@rendermode InteractiveServer

<PageTitle>API Tokens - MCP-API</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>API Tokens</h1>
    <button class="btn btn-primary" @onclick="ShowCreateModal" disabled="@isCreating">
        Create New Token
    </button>
</div>

<div class="alert alert-info mb-4">
    <strong>How to use:</strong> Set the <code>MCPAPI_TOKEN</code> environment variable to authenticate
    your MCP server. Tokens are shown only once when created - make sure to copy them!
</div>

@if (newToken != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <h5 class="alert-heading">Token Created Successfully!</h5>
        <p>Copy this token now - it will not be shown again:</p>
        <div class="input-group mb-3">
            <input type="text" class="form-control font-monospace" value="@newToken" readonly />
            <button class="btn btn-outline-secondary" type="button" @onclick="CopyToken">
                Copy
            </button>
        </div>
        <hr />
        <p class="mb-0">
            Set it in your environment: <code>export MCPAPI_TOKEN="@newToken"</code>
        </p>
        <button type="button" class="btn-close" aria-label="Close" @onclick="() => newToken = null"></button>
    </div>
}

@if (error != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @error
        <button type="button" class="btn-close" aria-label="Close" @onclick="() => error = null"></button>
    </div>
}

@if (isLoading)
{
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else if (tokens == null || tokens.Count == 0)
{
    <div class="alert alert-secondary">
        No API tokens yet. Create one to get started with MCP authentication.
    </div>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Expires</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var token in tokens)
            {
                <tr class="@(token.IsRevoked ? "table-secondary" : "")">
                    <td>@token.Name</td>
                    <td>@token.CreatedAt.ToString("MMM d, yyyy")</td>
                    <td>@(token.LastUsedAt?.ToString("MMM d, yyyy HH:mm") ?? "Never")</td>
                    <td>@(token.ExpiresAt?.ToString("MMM d, yyyy") ?? "Never")</td>
                    <td>
                        @if (token.IsRevoked)
                        {
                            <span class="badge bg-danger">Revoked</span>
                        }
                        else if (token.ExpiresAt.HasValue && token.ExpiresAt < DateTime.UtcNow)
                        {
                            <span class="badge bg-warning">Expired</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Active</span>
                        }
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            @if (!token.IsRevoked)
                            {
                                <button class="btn btn-outline-warning"
                                        @onclick="() => RevokeToken(token)"
                                        disabled="@isRevoking">
                                    Revoke
                                </button>
                            }
                            <button class="btn btn-outline-danger"
                                    @onclick="() => DeleteToken(token)"
                                    disabled="@isDeleting">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (showCreateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Token</h5>
                    <button type="button" class="btn-close" @onclick="HideCreateModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Token Name</label>
                        <input type="text" class="form-control" @bind="createTokenName"
                               placeholder="e.g., Development, Production, CI/CD" />
                        <div class="form-text">A friendly name to identify this token.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expiration (Optional)</label>
                        <select class="form-select" @bind="createTokenExpiry">
                            <option value="">Never expires</option>
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="365">1 year</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideCreateModal">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateToken"
                            disabled="@(isCreating || string.IsNullOrWhiteSpace(createTokenName))">
                        @if (isCreating)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Create Token
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private IReadOnlyList<McpToken>? tokens;
    private bool isLoading = true;
    private bool isCreating;
    private bool isRevoking;
    private bool isDeleting;
    private string? error;
    private string? newToken;

    private bool showCreateModal;
    private string createTokenName = "";
    private string createTokenExpiry = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadTokens();
    }

    private async Task LoadTokens()
    {
        isLoading = true;
        error = null;

        try
        {
            var userId = CurrentUserService.UserId;
            if (userId != null)
            {
                tokens = await TokenService.GetUserTokensAsync(userId);
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load tokens: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowCreateModal()
    {
        createTokenName = "";
        createTokenExpiry = "";
        showCreateModal = true;
    }

    private void HideCreateModal()
    {
        showCreateModal = false;
    }

    private async Task CreateToken()
    {
        if (string.IsNullOrWhiteSpace(createTokenName))
            return;

        isCreating = true;
        error = null;

        try
        {
            var userId = CurrentUserService.UserId;
            if (userId == null)
            {
                error = "User not authenticated.";
                return;
            }

            DateTime? expiresAt = null;
            if (!string.IsNullOrEmpty(createTokenExpiry) && int.TryParse(createTokenExpiry, out var days))
            {
                expiresAt = DateTime.UtcNow.AddDays(days);
            }

            var result = await TokenService.CreateTokenAsync(userId, createTokenName.Trim(), expiresAt);
            newToken = result.PlaintextToken;

            HideCreateModal();
            await LoadTokens();
        }
        catch (Exception ex)
        {
            error = $"Failed to create token: {ex.Message}";
        }
        finally
        {
            isCreating = false;
        }
    }

    private async Task RevokeToken(McpToken token)
    {
        isRevoking = true;
        error = null;

        try
        {
            var userId = CurrentUserService.UserId;
            if (userId != null)
            {
                await TokenService.RevokeTokenAsync(userId, token.Id);
                await LoadTokens();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to revoke token: {ex.Message}";
        }
        finally
        {
            isRevoking = false;
        }
    }

    private async Task DeleteToken(McpToken token)
    {
        isDeleting = true;
        error = null;

        try
        {
            var userId = CurrentUserService.UserId;
            if (userId != null)
            {
                await TokenService.DeleteTokenAsync(userId, token.Id);
                await LoadTokens();
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to delete token: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CopyToken()
    {
        // Note: In a real implementation, you'd use JavaScript interop to copy to clipboard
        // For now, the user can manually copy from the input field
    }
}
