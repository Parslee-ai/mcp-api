@page "/apis"
@using McpApi.Core.Models
@using McpApi.Web.Services
@inject ApiManagementService ApiService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>APIs - AnyAPI</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Registered APIs</h1>
    <a href="apis/register" class="btn btn-primary">Register New API</a>
</div>

@if (isLoading)
{
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else if (error != null)
{
    <div class="alert alert-danger">@error</div>
}
else if (apis == null || apis.Count == 0)
{
    <div class="alert alert-info">
        No APIs registered yet. <a href="apis/register">Register your first API</a>.
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Base URL</th>
                <th>Endpoints</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var api in apis)
            {
                <tr>
                    <td>
                        <a href="apis/@api.Id">@api.DisplayName</a>
                        <br />
                        <small class="text-muted">@api.Id</small>
                    </td>
                    <td><code>@api.BaseUrl</code></td>
                    <td>
                        @(endpointCounts.GetValueOrDefault(api.Id, (0, 0)).Item2) / @(endpointCounts.GetValueOrDefault(api.Id, (0, 0)).Item1)
                    </td>
                    <td>
                        @if (api.IsEnabled)
                        {
                            <span class="badge bg-success">Enabled</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Disabled</span>
                        }
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary"
                                    @onclick="() => ToggleApi(api)"
                                    disabled="@isToggling">
                                @(api.IsEnabled ? "Disable" : "Enable")
                            </button>
                            <a href="apis/@api.Id" class="btn btn-outline-primary">Details</a>
                            <button class="btn btn-outline-danger"
                                    @onclick="() => DeleteApi(api)"
                                    disabled="@isDeleting">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private IReadOnlyList<ApiRegistration>? apis;
    private Dictionary<string, (int total, int enabled)> endpointCounts = new();
    private bool isLoading = true;
    private bool isToggling;
    private bool isDeleting;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await LoadApis();
    }

    private async Task LoadApis()
    {
        isLoading = true;
        error = null;

        try
        {
            apis = await ApiService.GetAllApisAsync();

            // Load endpoint counts for each API
            endpointCounts.Clear();
            foreach (var api in apis)
            {
                var total = await ApiService.GetEndpointCountAsync(api.Id);
                var enabled = await ApiService.GetEnabledEndpointCountAsync(api.Id);
                endpointCounts[api.Id] = (total, enabled);
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load APIs: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ToggleApi(ApiRegistration api)
    {
        isToggling = true;
        try
        {
            await ApiService.ToggleApiAsync(api.Id, !api.IsEnabled);
            await LoadApis();
        }
        catch (Exception ex)
        {
            error = $"Failed to toggle API: {ex.Message}";
        }
        finally
        {
            isToggling = false;
        }
    }

    private async Task DeleteApi(ApiRegistration api)
    {
        isDeleting = true;
        try
        {
            await ApiService.DeleteApiAsync(api.Id);
            await LoadApis();
        }
        catch (Exception ex)
        {
            error = $"Failed to delete API: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }
}
